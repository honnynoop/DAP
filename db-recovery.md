# Database System 회복 기법 (Recovery Techniques)

## 1. 개요

**회복(Recovery)**이란 데이터베이스 장애(Failure) 발생 시 손상된 데이터베이스를 장애 발생 이전의 일관된 상태로 복원하는 과정이다. 회복의 핵심 원리는 **원자성(Atomicity)**과 **지속성(Durability)** 보장이다.

---

## 2. 장애(Failure) 유형

| 장애 유형 | 설명 | 예시 |
|---|---|---|
| **트랜잭션 장애** | 트랜잭션 수행 중 논리적 오류 또는 시스템 조건에 의해 비정상 종료 | 잘못된 입력값, 교착상태(Deadlock) |
| **시스템 장애** | 하드웨어/소프트웨어 결함으로 인해 메인 메모리 내용이 손실됨 | 정전, OS 충돌, DBMS 오류 |
| **미디어 장애** | 디스크 등 저장 장치의 물리적 손상으로 데이터 손실 | 디스크 헤드 충돌, 불량 섹터 |

---

## 3. 회복의 핵심 개념

### 3-1. 로그(Log) / 저널(Journal)

- 트랜잭션이 데이터베이스에 가한 **모든 변경 내용을 순서대로 기록**한 파일
- 회복의 가장 기본적인 수단
- 로그 레코드 구성: `[트랜잭션ID, 연산유형, 데이터항목, 이전값(Before Image), 이후값(After Image)]`

### 3-2. 체크포인트(Checkpoint)

- 주기적으로 메모리(버퍼)의 내용을 디스크에 강제로 기록하는 시점
- 회복 시 로그 전체를 탐색하지 않고 **가장 최근 체크포인트부터만** 처리하여 회복 시간 단축

### 3-3. REDO와 UNDO

| 연산 | 설명 | 적용 대상 |
|---|---|---|
| **REDO** | 이후값(After Image)을 이용해 트랜잭션을 **다시 수행** | 커밋 완료 후 디스크에 미반영된 트랜잭션 |
| **UNDO** | 이전값(Before Image)을 이용해 트랜잭션을 **취소/롤백** | 장애 시점에 완료되지 않은 트랜잭션 |

---

## 4. 회복 기법 종류

---

### 4-1. 로그 기반 회복 (Log-Based Recovery)

가장 일반적인 회복 기법. 모든 변경 내용을 로그에 기록하고 이를 이용해 회복한다.

#### (1) 즉시 갱신 (Immediate Update)

> 트랜잭션 수행 중 변경 내용을 **즉시 디스크에 반영**하고 로그도 함께 기록

- 트랜잭션이 완료되기 전에도 변경사항이 DB에 반영됨
- 장애 발생 시 **UNDO** 필요 (미완료 트랜잭션 롤백)
- 커밋된 트랜잭션 중 디스크 미반영분은 **REDO** 수행

| 구분 | 처리 |
|---|---|
| 커밋 완료 + 디스크 반영 | 조치 없음 |
| 커밋 완료 + 디스크 미반영 | **REDO** |
| 커밋 미완료 | **UNDO** |

#### (2) 지연 갱신 (Deferred Update)

> 트랜잭션이 **커밋된 이후에만** 변경 내용을 디스크에 반영

- 커밋 전 변경사항은 로그에만 기록, DB에는 미반영
- 장애 발생 시 UNDO 불필요 — 단순 **로그 폐기**로 처리
- 커밋 완료 후 미반영분만 **REDO** 수행

| 구분 | 처리 |
|---|---|
| 커밋 완료 + 디스크 반영 | 조치 없음 |
| 커밋 완료 + 디스크 미반영 | **REDO** |
| 커밋 미완료 | 로그 폐기 (UNDO 불필요) |

---

### 4-2. 체크포인트 회복 (Checkpoint Recovery)

> 주기적 체크포인트 시점을 기준으로 회복 범위를 **최소화**하는 기법

- 체크포인트 시점에 모든 버퍼를 디스크에 강제 저장 (Force Write)
- 회복 시 체크포인트 이전 트랜잭션은 이미 디스크에 반영되어 있으므로 무시
- 체크포인트 이후의 로그만 분석하여 REDO/UNDO 수행

```
──────────────────────────────────────────────────────▶ 시간
      Checkpoint                         Failure
          │                                 │
          ▼                                 ▼
──────────┬─────────────────────────────────┤
    T1 ───┤(이미 완료, REDO 대상)            │
          │     T2 ─────────────────────────┤ REDO 대상 (커밋 완료)
          │         T3 ─────────────────────┤ UNDO 대상 (미완료)
          │                   T4 ───────────┤ REDO 대상 (커밋 완료)
          │                        T5 ──────┤ UNDO 대상 (미완료)
```

---

### 4-3. 그림자 페이징 (Shadow Paging)

> 원본 페이지를 수정하는 대신, **그림자(Shadow) 복사본**을 이용해 변경 작업을 수행하는 기법

- 트랜잭션 시작 시 현재 페이지 테이블을 **그림자 페이지 테이블**로 복사
- 변경 시 새로운 페이지에 작성, 그림자는 그대로 유지
- 커밋 시 현재 페이지 테이블을 공식 테이블로 교체
- 장애 시 그림자 페이지 테이블로 복원 (UNDO 불필요)

| 구분 | 내용 |
|---|---|
| **장점** | 로그 불필요, UNDO 연산 없음, 회복 단순 |
| **단점** | 페이지 단편화 발생, 동시성 제어 어려움, 오버헤드 큼 |
| **적용** | 소규모, 단일 사용자 환경에 적합 |

---

### 4-4. ARIES 회복 알고리즘 (Algorithms for Recovery and Isolation Exploiting Semantics)

> IBM 연구진이 개발한 현대 DBMS의 표준 회복 알고리즘으로, 대부분의 상용 DBMS(Oracle, SQL Server, PostgreSQL 등)가 채택

3단계로 수행:

| 단계 | 명칭 | 설명 |
|:---:|---|---|
| 1단계 | **분석(Analysis)** | 체크포인트부터 로그 순방향 탐색, 장애 시점의 활성 트랜잭션 목록 및 더티 페이지 파악 |
| 2단계 | **REDO** | 분석 단계에서 파악한 가장 오래된 LSN부터 순방향으로 모든 변경 재수행 (커밋 여부 무관) |
| 3단계 | **UNDO** | 역방향으로 미완료 트랜잭션의 변경사항 취소 |

**핵심 특징:**
- **Write-Ahead Logging (WAL)**: 디스크에 데이터 쓰기 전 반드시 로그 먼저 기록
- **LSN (Log Sequence Number)**: 로그 레코드 고유 번호로 회복 지점 추적
- **CLR (Compensation Log Record)**: UNDO 연산 자체를 로그에 기록하여 UNDO 중 장애 발생 시 재처리 방지

---

### 4-5. 미디어 회복 (Media Recovery)

> 디스크 물리적 손상 시 **백업본과 로그 아카이브**를 이용해 복원하는 기법

#### 백업(Backup) 유형

| 유형 | 설명 | 장점 | 단점 |
|---|---|---|---|
| **전체 백업 (Full Backup)** | DB 전체를 백업 | 회복 단순, 빠름 | 시간·공간 소모 큼 |
| **증분 백업 (Incremental Backup)** | 직전 백업 이후 변경분만 백업 | 백업 시간·용량 절감 | 회복 시 여러 백업본 필요 |
| **차등 백업 (Differential Backup)** | 마지막 전체 백업 이후 변경분 전체 백업 | 증분 대비 회복 단순 | 시간이 지날수록 용량 증가 |

#### 미디어 회복 절차

```
1. 가장 최근 전체 백업본 복원
2. 증분/차등 백업본 순서대로 적용
3. 아카이브 로그를 순방향으로 REDO 적용
4. 장애 시점까지 복원 완료
```

---

## 5. 회복 기법 비교 요약표

| 기법 | 핵심 원리 | REDO | UNDO | 로그 필요 | 장점 | 단점 |
|---|---|:---:|:---:|:---:|---|---|
| **즉시 갱신** | 변경 즉시 DB 반영 | ✅ | ✅ | ✅ | 실시간 반영 | UNDO 오버헤드 |
| **지연 갱신** | 커밋 후 DB 반영 | ✅ | ❌ | ✅ | UNDO 불필요 | 커밋 전 메모리 부담 |
| **체크포인트** | 주기적 강제 기록 | ✅ | ✅ | ✅ | 회복 범위 최소화 | 체크포인트 오버헤드 |
| **그림자 페이징** | 복사본 활용 | ❌ | ❌ | ❌ | 단순, 로그 불필요 | 단편화, 동시성 약함 |
| **ARIES** | WAL + LSN 추적 | ✅ | ✅ | ✅ | 견고함, 표준화 | 구현 복잡 |
| **미디어 회복** | 백업 + 아카이브 로그 | ✅ | ❌ | ✅ | 물리 장애 대응 | 회복 시간 길 수 있음 |

---

## 6. WAL (Write-Ahead Logging) 원칙

모든 로그 기반 회복 기법의 공통 전제 원칙:

> **"데이터베이스에 변경 내용을 기록하기 전에, 반드시 로그를 먼저 안정적 저장 장치에 기록해야 한다."**

| 규칙 | 설명 |
|---|---|
| **UNDO 규칙** | 데이터 페이지를 디스크에 쓰기 전, UNDO 로그 레코드를 먼저 기록 |
| **REDO 규칙** | 트랜잭션 커밋 전, 모든 REDO 로그 레코드를 먼저 기록 |

---

## 7. 핵심 정리

```
회복 기법의 선택 기준

소규모·단순 환경       →  그림자 페이징
일반적인 OLTP 환경     →  즉시 갱신 + 체크포인트 (+ ARIES)
대용량·고가용성 환경   →  ARIES + 미디어 회복 + 이중화
커밋 안정성 최우선      →  지연 갱신
```
